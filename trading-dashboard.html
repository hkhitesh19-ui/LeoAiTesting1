<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model E | Institutional Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0d0e12; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); transition: all 0.3s ease; }
        .glass:hover { border-color: rgba(34, 211, 238, 0.4); box-shadow: 0 0 20px rgba(34, 211, 238, 0.1); }
        .neon-text { text-shadow: 0 0 8px rgba(34, 211, 238, 0.6); }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-black tracking-tighter neon-text text-cyan-400">MODEL E</h1>
                <p class="text-xs uppercase tracking-[0.3em] text-gray-500 font-bold">Institutional Trading Engine</p>
                    </div>
            <div id="status-badge" class="px-4 py-2 rounded-full glass text-xs font-bold text-green-400 flex items-center gap-2">
                <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>
                ENGINE LIVE
            </div>
        </div>

        <!-- Top Metrics Row -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="glass p-6 rounded-3xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Market Volatility (VIX)</p>
                <h3 id="vix" class="text-3xl font-mono font-bold text-white">--.--</h3>
                <p id="vix-close" class="text-xs text-gray-400 mt-1">Prev: --.--</p>
                    </div>
            <div class="glass p-6 rounded-3xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Active Scaling Gear</p>
                <h3 id="gear" class="text-3xl font-mono font-bold text-orange-400">Neutral</h3>
            </div>
            <div class="glass p-6 rounded-3xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Friction Journal</p>
                <h3 id="friction" class="text-3xl font-mono font-bold text-red-500">-8.00 Pts</h3>
            </div>
            <div class="glass p-6 rounded-3xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-4 tracking-widest">Current Net Equity</p>
                <h3 id="equity" class="text-3xl font-mono font-bold text-green-400">â‚¹ 5,00,000</h3>
            </div>
        </div>

        <!-- Trinity View: Market Structure -->
        <div class="glass p-6 rounded-3xl mb-6">
            <h2 class="text-lg font-bold text-cyan-400 mb-4 uppercase tracking-wide">Market Structure - Trinity View</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass p-4 rounded-xl">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Nifty Spot</p>
                    <div class="flex justify-between items-baseline">
                        <h4 id="spot-ltp" class="text-2xl font-bold font-mono">--</h4>
                        <span id="spot-close" class="text-xs text-gray-400">Prev: --</span>
                </div>
                    <p id="spot-change" class="text-xs mt-1">--</p>
                </div>
                <div class="glass p-4 rounded-xl border-l-2 border-cyan-500 shadow-[0_0_15px_rgba(0,255,255,0.1)]">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] text-orange-400 uppercase font-bold">Current Future</p>
                        <span class="text-[10px] bg-orange-500/20 px-2 py-0.5 rounded text-orange-300">Basis: <span id="curr-basis-inline" class="font-mono font-bold">--</span></span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <h4 id="fut-curr-ltp" class="text-2xl font-bold font-mono">--</h4>
                        <span id="fut-curr-close" class="text-xs text-gray-400">Prev: --</span>
                    </div>
                    <p id="fut-curr-change" class="text-xs mt-1">--</p>
                </div>
                <div class="glass p-4 rounded-xl">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-[10px] text-purple-400 uppercase font-bold">Next Future</p>
                        <span class="text-[10px] bg-purple-500/20 px-2 py-0.5 rounded text-purple-300">Basis: <span id="next-basis-inline" class="font-mono font-bold">--</span></span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <h4 id="fut-next-ltp" class="text-2xl font-bold font-mono">--</h4>
                        <span id="fut-next-close" class="text-xs text-gray-400">Prev: --</span>
                    </div>
                    <p id="fut-next-change" class="text-xs mt-1">--</p>
                </div>
            </div>
            <!-- Basis Visualization - Progress Bars -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="glass p-3 rounded-lg border-l-4 border-orange-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400 uppercase font-bold">Current Basis</span>
                        <span id="curr-basis-val" class="font-bold text-orange-400 font-mono">0.00</span>
                    </div>
                    <div class="w-full bg-gray-700 h-1.5 mt-2 rounded-full overflow-hidden">
                        <div id="curr-basis-bar" class="bg-orange-500 h-full transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>
                <div class="glass p-3 rounded-lg border-l-4 border-purple-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-400 uppercase font-bold">Next Basis (Roll)</span>
                        <span id="next-basis-val" class="font-bold text-purple-400 font-mono">0.00</span>
                    </div>
                    <div class="w-full bg-gray-700 h-1.5 mt-2 rounded-full overflow-hidden">
                        <div id="next-basis-bar" class="bg-purple-500 h-full transition-all duration-300" style="width: 50%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Indicators -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="glass p-4 rounded-xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Engine Latency</p>
                <p id="latency" class="text-lg font-mono font-bold text-green-400">-- ms</p>
                                </div>
            <div class="glass p-4 rounded-xl">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">API Connectivity</p>
                <p id="api-status" class="text-lg font-mono font-bold text-green-400">Connected</p>
            </div>
        </div>

        <!-- Heartbeat Footer -->
        <div class="mt-6 text-center">
            <p id="heartbeat" class="text-[10px] text-gray-600 font-mono italic uppercase">Awaiting Data Sync...</p>
        </div>
    </div>

    <script>
        let lastFetchTime = Date.now();
        
        async function fetchStatus() {
            const fetchStart = Date.now();
            try {
                const res = await fetch('/get_status');
                const data = await res.json();
                
                // Calculate latency
                const latency = Date.now() - fetchStart;
                document.getElementById('latency').innerText = `${latency} ms`;
                
                // Update VIX
                const vixValue = data.vix_ltp || data.currentVix || 0;
                const vixClose = data.vix_close || 0;
                document.getElementById('vix').innerText = vixValue.toFixed(2);
                document.getElementById('vix-close').innerText = `Prev: ${vixClose.toFixed(2)}`;
                
                // Update Gear
                const gearStatus = data.gearStatus || data.gear_status || 'Neutral';
                document.getElementById('gear').innerText = gearStatus;
                
                // Update Equity (Fixed at 5 Lakhs)
                if (data.equity) {
                    document.getElementById('equity').innerText = data.equity;
                }
                
                // Update Friction
                if (data.friction) {
                    document.getElementById('friction').innerText = data.friction;
                }
                
                // Trinity View - Spot
                const spotLtp = data.spot_ltp || 0;
                const spotClose = data.spot_close || 0;
                document.getElementById('spot-ltp').innerText = spotLtp.toFixed(2);
                document.getElementById('spot-close').innerText = `Prev: ${spotClose.toFixed(2)}`;
                const spotChange = spotLtp - spotClose;
                const spotChangeEl = document.getElementById('spot-change');
                spotChangeEl.innerText = `${spotChange >= 0 ? '+' : ''}${spotChange.toFixed(2)} (${((spotChange/spotClose)*100).toFixed(2)}%)`;
                spotChangeEl.className = `text-xs mt-1 ${spotChange >= 0 ? 'price-up' : 'price-down'}`;
                
                // Trinity View - Current Future
                const futCurrLtp = data.fut_curr_ltp || data.ltp || 0;
                const futCurrClose = data.fut_curr_close || data.lastClose || 0;
                document.getElementById('fut-curr-ltp').innerText = futCurrLtp.toFixed(2);
                document.getElementById('fut-curr-close').innerText = `Prev: ${futCurrClose.toFixed(2)}`;
                const futCurrChange = futCurrLtp - futCurrClose;
                const futCurrChangeEl = document.getElementById('fut-curr-change');
                futCurrChangeEl.innerText = `${futCurrChange >= 0 ? '+' : ''}${futCurrChange.toFixed(2)} (${((futCurrChange/futCurrClose)*100).toFixed(2)}%)`;
                futCurrChangeEl.className = `text-xs mt-1 ${futCurrChange >= 0 ? 'price-up' : 'price-down'}`;
                
                // Trinity View - Next Future
                const futNextLtp = data.fut_next_ltp || 0;
                const futNextClose = data.fut_next_close || 0;
                document.getElementById('fut-next-ltp').innerText = futNextLtp.toFixed(2);
                document.getElementById('fut-next-close').innerText = `Prev: ${futNextClose.toFixed(2)}`;
                const futNextChange = futNextLtp - futNextClose;
                const futNextChangeEl = document.getElementById('fut-next-change');
                futNextChangeEl.innerText = `${futNextChange >= 0 ? '+' : ''}${futNextChange.toFixed(2)} (${((futNextChange/futNextClose)*100).toFixed(2)}%)`;
                futNextChangeEl.className = `text-xs mt-1 ${futNextChange >= 0 ? 'price-up' : 'price-down'}`;
                
                // Basis Calculation - Real-time (Future - Spot)
                const currBasis = futCurrLtp - spotLtp;
                const nextBasis = futNextLtp - spotLtp;
                
                // Update inline basis badges
                const currBasisInline = document.getElementById('curr-basis-inline');
                const nextBasisInline = document.getElementById('next-basis-inline');
                if (currBasisInline) currBasisInline.innerText = currBasis.toFixed(2);
                if (nextBasisInline) nextBasisInline.innerText = nextBasis.toFixed(2);
                
                // Update basis visualization (progress bars)
                const currBasisVal = document.getElementById('curr-basis-val');
                const nextBasisVal = document.getElementById('next-basis-val');
                const currBasisBar = document.getElementById('curr-basis-bar');
                const nextBasisBar = document.getElementById('next-basis-bar');
                
                if (currBasisVal) currBasisVal.innerText = currBasis.toFixed(2);
                if (nextBasisVal) nextBasisVal.innerText = nextBasis.toFixed(2);
                
                // Progress bar calculation (normalize to 0-100% based on typical basis range 0-100)
                // Basis typically ranges from 0 to 100 points, so we normalize accordingly
                const maxBasis = 100; // Maximum expected basis
                const currBasisPercent = Math.min(100, Math.max(0, (currBasis / maxBasis) * 100));
                const nextBasisPercent = Math.min(100, Math.max(0, (nextBasis / maxBasis) * 100));
                
                if (currBasisBar) currBasisBar.style.width = `${currBasisPercent}%`;
                if (nextBasisBar) nextBasisBar.style.width = `${nextBasisPercent}%`;
                
                // Update bottom basis display (if exists)
                const currBasisEl = document.getElementById('curr-basis');
                const nextBasisEl = document.getElementById('next-basis');
                if (currBasisEl) currBasisEl.innerText = currBasis.toFixed(2);
                if (nextBasisEl) nextBasisEl.innerText = nextBasis.toFixed(2);
                
                // API Status
                const apiStatus = data.bot_connected ? 'Connected' : 'Disconnected';
                const apiStatusEl = document.getElementById('api-status');
                apiStatusEl.innerText = apiStatus;
                apiStatusEl.className = `text-lg font-mono font-bold ${data.bot_connected ? 'text-green-400' : 'text-red-400'}`;
                
                // Update Heartbeat
                const engineStatus = data.model_e_active !== false ? 'READY' : 'ERROR';
                document.getElementById('heartbeat').innerText = `Sync: ${new Date().toLocaleTimeString()} | Engine: ${engineStatus} | Latency: ${latency}ms`;
                
            } catch (err) {
                document.getElementById('heartbeat').innerText = "CONNECTION LOST";
                document.getElementById('api-status').innerText = 'Disconnected';
                document.getElementById('api-status').className = 'text-lg font-mono font-bold text-red-400';
                console.error('Status fetch error:', err);
            }
        }
        
        setInterval(fetchStatus, 3000);
        fetchStatus();
    </script>
</body>
</html>
